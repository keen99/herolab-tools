<!-- version 306 -->

<!DOCTYPE html>
<style>
  @media print {

    /* THIS causes our columns to flow properly from page to page*/
    /* set page size and margins */
    @page {
      size: letter;
      margin: 1.5cm;
    }
  }


  .element-path {
    font-weight: lighter;
    font-size: 20%;
    float: right;
    display: inline-block
  }

  .name-heading {
    font-weight: bold;
    display: inline-block;
  }

  .description-text {
    /*white-space: pre-wrap;*/
    white-space: pre-wrap !important;
    /* The pre-wrap value preserves newlines and whitespace characters, while allowing text to wrap to the next line. You can use this property to achieve a similar effect to the <pre> element, without actually using the <pre> element in your HTML. */
    word-break: keep-all;
    /* to allow the text to break in between words if the text is too long. */
    font-size: 80%;
    /* match the <pre> style*/
    font-family: monospace;
    /*font-size: 14px;*/
    line-height: 1.5;
    color: #333;
  }

  /* Style the header */
  .page-header {
    /*position: absolute;*/
    /*top: 0;*/
    text-align: center;
    /*display: block;*/
    /*font-size: 20px;*/
    /*margin-bottom: 20px;*/
  }

  /* Style the footer */
  .page-footer {
    /*position: absolute;*/
    /*bottom: 0;*/
    text-align: center;
    /*display: block;*/
    /*font-size: 12px;*/
    /*margin-top: 20px;*/
  }

  .main-container {
    /*position: relative;*/
    min-height: 100%;
    display: flex;
    flex-direction: column;
  }

  .main-container-flex {
    display: flex;
    flex-direction: column;
    min-height: 100%;
  }

  .grid-container {
    flex: 1;
    /* This will make grid-container take the remaining space after header and footer */
    column-count: 2;
    /* creates two columns */
    column-gap: 10px;
    /* adds some space between columns */
    width: 80%;
    /* adjust as needed */
    margin: 0 auto;
    /* center the columns */
    margin: auto;
    /* center the columns */
  }

  @media screen and (max-width: 600px) {
    .grid-container {
      column-count: 1;
      /* 1 column for screen widths less than 600px */
    }
  }

  .grid-item {}

  .grid-item.container {
    border: 1px solid black;
    /*or any other border properties you would like*/
    padding: 10px;
    /* add some space between the border and the contents */
  }

/*#filterPaths, #filterNames {
    display: inline-block;
    vertical-align: top;
    width: 49%;
}
*/
#filterContainer{
    display: grid;
    grid-template-columns: 1fr 1fr;
}



</style>
<html>
  <head>
    <script >
      document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("xml-file").onchange = function(){processXmlFile(false)};
      });
    </script>
    <script src="js/extractor.js"></script>
    <script src="js/utilities.js"></script>
    <script src="js/ignoredElements.js"></script>
  </head>
  <body>
    <div id="status">
    <!-- <div id="description"> -->
      <h2>HeroLab XML Data Extractor</h2>
      <p>This tool allows you to easily extract item, object, and power descriptions from HeroLab character sheets exported in XML format.</p>
      <p>To use the tool, start by exporting your HeroLab character sheet in XML format. In HeroLab, go to the File menu, select Save Custom Output, and choose Generate XML File. Save the file to your computer.</p>
      <p>Next, upload the XML file using the file input field on this page or use one of the provided sample files for a demo. The extracted data will be displayed on the page and can be saved as a PDF for future reference using your browser's Print function.</p>
       <ul>
        <li><a href="https://github.com/keen99/herolab-tools"> herolab-tools repo</a> - Source freely available on github</li>
      </ul>
    </div>

<input type="file" id="xml-file" accept="application/xml, text/xml, .xml" onchange="addName();">
<div id="xml-button">
  <button id="xml-button-1" onclick="addName(); processXmlFile('sample-xml/Bronn_Skyfall_L6.xml')">Sample - Bronn_Skyfall_L6.xml</button>
  <button id="xml-button-2" onclick="addName(); processXmlFile('sample-xml/Bronn_Skyfall_L7.xml')">Sample - Bronn_Skyfall_L7.xml</button>
  <button id="xml-button-3" onclick="addName(); processXmlFile('sample-xml/Flen_Nightinfire.6.xml')">Sample - Flen_Nightinfire.6.xml</button>
</div>

      <form id="addNameForm" onsubmit="addName(); return false;">
        <label for="nameInput">Add Custom Filter (path or name):</label>
        <input type="text" id="nameInput" name="nameInput">
        <input type="submit" value="Add">
      </form>
    <div id="filterContainer">
      <div id="filterPaths"></div>
      <div id="filterNames"></div>


    </div>

<script>


window.addEventListener('load', function() {
    // code to execute when the page has finished loading
    // Get the current URL
    const url = new URL(window.location);
    // Get the search params
    const searchParams = new URLSearchParams(url.search);
    var checked = new Set();
    for (const [key, value] of searchParams.entries()) {
        var checkbox = document.getElementById(key);
    if (!checkbox) {
        console.log("adding custom checkbox from params: " + key + " " + value)
        if(key.startsWith("./")){
            console.log("path");
            // force the BOOL of value instead of the string from the param
            createCheckbox(key, "filterPaths", value, true);
        } else {
            console.log("name");
            createCheckbox(key, "filterNames", value, true);
        }
        checkbox = document.getElementById(key);
        console.log(checkbox);
    }
        // This is likely done to ensure that each checkbox element is only checked once, even if the same key appears multiple times in the search parameters.
        if (!checked.has(key)) {
            // console.log("updating checkbox.checked to value: " + (value === 'true'));
            checkbox.checked = (value === 'true');
            checked.add(key);
        }
    }
});


function addName() {
  var nameInput = document.getElementById("nameInput").value;
  ignoredNames[nameInput] = true;
  if(nameInput.startsWith("./")){
      createCheckbox(nameInput, "filterPaths", true, true);
  } else {
      createCheckbox(nameInput, "filterNames", true, true);
  }
}

function updateUrlParams(checkbox) {
    const url = new URL(window.location);
    const urlParams = new URLSearchParams(url.search);

    console.log("updateUrlParams checked: " + checkbox.checked, "custom: " + checkbox.custom);
    console.log(checkbox);
    // add to url params when
    // checkbox.custom = true
    // or
    // checkbox.custom = false and checkbox.checked = false
    if (checkbox.custom === true || (checkbox.custom === false && checkbox.checked === false)) {
        console.log(`Adding ${checkbox.value} to the URL query: ${url.href}`);
        // convert checkbox.checked from a boolean to a string
        let checkedValue = checkbox.checked ? 'true' : 'false';
        urlParams.set(checkbox.value, checkedValue);
    // remove from url params when
    // checkbox.custom = false
    // and
    // checkbox.checked = true
    } else if (checkbox.custom === false && checkbox.checked === true) {
        console.log(`Removing ${checkbox.value} from the URL query: ${url.href}`);
        urlParams.delete(checkbox.value);
    }
    url.search = urlParams.toString();
    history.pushState(null, null, url);
    console.log(`Updated URL query: ${url.href}`);
}


function createCheckbox(value, containerId, checked = true, custom = false) {
    console.log("createCheckbox was called:  ", value, checked, custom)

    // force this to a bool. sometimes it could be a string, which doesnt work for the .checked property
    if(typeof checked === 'string') checked = (checked === 'true');
    if(typeof custom === 'string') custom = (custom === 'true');

    console.log("createCheckbox was called:  ", value, checked, custom)
    var existingCheckbox = document.getElementById(value);
    if (existingCheckbox) {
        console.log("createCheckbox skipping existing");
        return;
    }
    var checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = value;
    checkbox.id = value;
    checkbox.name = "options";
    console.log("checked:", checked);
    checkbox.checked = checked;
    console.log("checkbox.checked:", checkbox.checked, checked);
    checkbox.custom = custom;
    console.log("checkbox.custom:", checkbox.custom);

    // we need this for when we're called from Add
    if (custom && !existingCheckbox) {
        console.log("update for custom checkbox");
        updateUrlParams(checkbox);
    }
    checkbox.onchange = function(event) {
        updateUrlParams(checkbox);
    }
    var label = document.createElement("label");
    label.htmlFor = value;
    label.innerHTML = value;

    var container = document.getElementById(containerId);
    container.appendChild(checkbox);
    container.appendChild(label);
    container.appendChild(document.createElement("br"));
}

// Create checkboxes for ignoredPaths
for (var path in ignoredPaths) {
  if (ignoredPaths.hasOwnProperty(path)) {
    createCheckbox(path, "filterPaths");
  }
}

// Create checkboxes for ignoredNames
for (var name in ignoredNames) {
  if (ignoredNames.hasOwnProperty(name)) {
    createCheckbox(name, "filterNames");
  }
}

// Create header for filterPaths column
var filterPathsHeader = document.createElement("h3");
filterPathsHeader.innerHTML = "Filter Paths";
document.getElementById("filterPaths").prepend(filterPathsHeader);

// Create header for filterNames column
var filterNamesHeader = document.createElement("h3");
filterNamesHeader.innerHTML = "Filter Names";
document.getElementById("filterNames").prepend(filterNamesHeader);

var filterPathsContainer = document.getElementById("filterPaths");
var filterNamesContainer = document.getElementById("filterNames");

var instructionText = "These elements are normally excluded. Select them to include them.";
var filterPathsInstruction = document.createElement("p");
filterPathsInstruction.innerHTML = instructionText;
filterPathsContainer.appendChild(filterPathsInstruction);

var filterNamesInstruction = document.createElement("p");
filterNamesInstruction.innerHTML = instructionText;
filterNamesContainer.appendChild(filterNamesInstruction);


</script>


    </div>
      <div class="main-container main-container-flex">
        <div class="page-header"></div>
        <div class="grid-container"></div>
        <div class="page-footer"></div>
      </div>
  </body>
</html>

<!-- // END OF FILE -->
